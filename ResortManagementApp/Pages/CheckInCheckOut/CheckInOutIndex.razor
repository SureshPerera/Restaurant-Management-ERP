@page "/Reservations/CheckInOut"
@using MudBlazor
@using ResortManagementApp.Models.Reservation
@using ResortManagementApp.Models.Reservation.DTO
@using ResortManagementApp.Models.Reservation.OnlineBookingModel
@using ResortManagementApp.Pages.ComponentCss
@using System.Text.Json
@using System.Text
@layout MainLayout
@inject IJSRuntime JS
@inject ISnackbar Snackbar
@inject HttpClient Http
@inject NavigationManager Nav
<link href="css/checkInOut.css" rel="stylesheet" />

<div class="container-fluid my-4">
	<!-- PAGE HEADER -->
	<div class="text-center mb-5">
		<h2 class="fw-bold rounded py-3 text-white" style="background-color:#344e41;">Check-In / Check-Out Management</h2>
		<p class="page-subtitle" style="color:white; font-weight:bold">Manage reservations, guest arrivals, departures, and billing</p>
	</div>



				<!-- FILTER SECTION -->
				<div class="card filter-card mb-5">
					<div class="card-body">
						<div class="row g-3 align-items-end">

							<div class="col-md-4">
								<label class="form-label">Search Guest</label>
								<input type="search" class="form-control"
									   placeholder="Name / NIC / Phone" />
							</div>

							<div class="col-md-3">
								<label class="form-label">From Date</label>
								<input type="date" class="form-control" />
							</div>

							<div class="col-md-3">
								<label class="form-label">To Date</label>
								<input type="date" class="form-control" />
							</div>

							<div class="col-md-2 d-grid">
								<button class="btn btn-primary-custom"
										@onclick="clickViewAllReservations">
									View
								</button>
							</div>

						</div>
					</div>
				</div>
			
		
	
</div>
<div>
	<!-- Reservation Table -->
	<div class="card shadow-sm">
		<div class="card-body p-0">
			@if (directBookingModels == null)
			{
				<div class="d-flex justify-content-center py-5">
					<Searching />
				</div>
			}
			else
			{
				<div class="card rounded-3 border-0 shadow-sm">
					<div class="card-header" style="background-color:#588157; color:white;">
						<h5 class="mb-0">All Reservations</h5>
					</div>
					<div class="card-body p-0">
						<div class="table-responsive">
							<table class="table-hover mb-0 table align-middle">
								<thead style="background-color:#dad7cd;" class="text-center">
									<tr>
										<th>Id</th>
										<th>Name</th>
										<th>Check-In</th>
										<th>Time</th>
										<th>Check-Out</th>
										<th>Time</th>
										<th>Status</th>
										<th>Type</th>
										<th class="text-center">Actions</th>
									</tr>
								</thead>
								<tbody>
									@foreach (var item in directBookingModels)
									{
										<tr class="text-center">
											<td>@item.Id</td>
											<td>@($"{item.FirstName} {item.LastName}")</td>
											<td>@item.CheckInDate.ToString("yyyy-MM-dd")</td>
											<td>@item.CheckInTime</td>
											<td>@item.CheckOutDate.ToString("yyyy-MM-dd")</td>
											<td>@item.CheckOutTime</td>
											<td>
												@if (item.Conformation)
												{
													<span class="badge bg-success">Confirmed</span>
												}
												else
												{

													<span class="badge bg-warning text-dark">Pending</span>
												}
											</td>
											<td>@item.CustomerType</td>
											<td>
												<button class="btn btn-sm btn-outline-primary"
														@onclick="() => ClickConformationsDirect(item.Id)">
													Bill View
												</button>
											</td>
										</tr>
									}

									@foreach (var item in onlineBookingModels!)
									{
										<tr class="text-center">
											<td>@item.Id</td>
											<td>@($"{item.FirstName} {item.LastName}")</td>
											<td>@item.CheckInDate</td>
											<td>@item.CheckInTime</td>
											<td>@item.CheckOutDate</td>
											<td>@item.CheckOutTime</td>
											<td>
												@if (item.Conformation)
												{
													<span class="badge bg-success">Confirmed</span>
												}
												else
												{

													<span class="badge bg-warning text-dark">Pending</span>
												}
											</td>
											<td>@item.CustomerType</td>
											<td>
												<button class="btn btn-sm btn-outline-primary"
														@onclick="() => ClickConformationsOnline(item.Id)">
													Bill View
												</button>
											</td>
										</tr>
									}
								</tbody>
							</table>
						</div>
					</div>
				</div>
			}
		</div>
	</div>

	@if (PagedateLoad)
	{
		<section id="invoice-section" class="invoice-wrapper my-5">

			<div class="row g-4">

				<!-- ACTION PANEL -->
				<div class="col-lg-3">
					<div class="card invoice-action-card">
						<div class="card-body">

							<div class="status-box mb-3">
								<span>Status</span>
								<strong class="@(Conformation ? "text-success" : "text-warning")">
									@(Conformation ? "Confirmed" : "Pending")
								</strong>
							</div>

							<div class="balance-box mb-4">
								<span>Outstanding Balance</span>
								<h5 class="text-success">LKR @totalBalanceLKR</h5>
							</div>

							@if (!Conformation)
							{
								<button class="btn btn-success w-100 mb-2" @onclick="clickConform">
									Confirm Reservation
								</button>
							}
							else if (!CheckIn)
							{
								<button class="btn btn-warning w-100 mb-2" @onclick="clickUnConform">
									Unconfirm
								</button>
							}

							@if (!CheckIn)
							{
								<button class="btn btn-primary w-100 mb-2"
										@onclick="@(() => clickAdvancePay(Id))">
									Advance Payment
								</button>
							}

							<button class="btn btn-outline-secondary w-100 mb-2">GRC Print</button>
							<button class="btn btn-outline-secondary w-100 mb-3">RCV Print</button>

							<button class="btn btn-danger w-100 mb-2" @onclick="clickCancellation">
								Cancel Reservation
							</button>

							@if (!CheckIn)
							{
								<button class="btn btn-dark w-100" @onclick="ClickCheckIn">
									Check-In
								</button>
							}

							@if (CheckIn && !CheckOut)
							{
								<button class="btn btn-success w-100" @onclick="ClickCheckOut">
									Check-Out
								</button>
							}

						</div>
					</div>
				</div>

				<!-- INVOICE VIEW -->
				<div class="col-lg-9">
					<div class="card invoice-card">

						<!-- HEADER -->
						<div class="invoice-header">
							<div>
								<h5>Proforma Invoice</h5>
								<small>Reservation ID : @Id</small>
							</div>
							<img src="/imgs/maindashboard/logo.png" alt="Logo" />
						</div>

						<div class="card-body">

							<!-- RESORT INFO -->
							<div class="info-box mb-4">
								<h6>Solitory Green Resort</h6>
								<p>
									Oddington Estate, Lindula<br />
									Nuwara Eliya, Sri Lanka<br />
									📞 0761733573 | ✉️ sgncabins6@gmail.com
								</p>
							</div>

							<!-- CUSTOMER DETAILS -->
							<div class="row info-grid mb-4">
								<div class="col-md-6">
									<h6>Customer Details</h6>
									<p><strong>Name:</strong> @name</p>
									<p><strong>Phone:</strong> @phone</p>
									<p><strong>Email:</strong> @email</p>
									<p><strong>Address:</strong> @address</p>
								</div>

								<div class="col-md-6">
									<h6>Reservation Info</h6>
									<p><strong>Customer Type:</strong> @CustomerType</p>
									<p><strong>Accommodation:</strong> @AccomadationType</p>
									<p><strong>Agent:</strong> @agentName</p>
								</div>
							</div>

							<!-- STAY SUMMARY -->
							<div class="stay-summary mb-4">
								<div>
									<span>Check-In</span>
									<strong>@CheckInDate.ToString("yyyy-MM-dd")</strong>
								</div>
								<div>
									<span>Check-Out</span>
									<strong>@CheckOutDate.ToString("yyyy-MM-dd")</strong>
								</div>
								<div>
									<span>Adults</span>
									<strong>@adults</strong>
								</div>
								<div>
									<span>Kids</span>
									<strong>@kids</strong>
								</div>
							</div>

							<!-- BILL SUMMARY -->
							<div class="bill-summary">
								<div><span>Adults Stay Total</span><span>LKR @adultsStayTotal</span></div>
								<div><span>Kids Stay Total</span><span>LKR @kidsStayTotal</span></div>
								<div class="total"><span>Grand Total</span><span>LKR @grandTotal</span></div>
								<div><span>Advance Paid</span><span>LKR @totalAdvancePayment</span></div>
								<div class="balance"><span>Balance</span><span>LKR @totalBalanceLKR</span></div>
							</div>

							<!-- FOOTER -->
							<div class="invoice-footer text-center mt-4">
								<p><strong>Remark:</strong> Transparent Management</p>
								<small>Powered by Liya SOFT PVT LTD</small>
							</div>

						</div>
					</div>
				</div>

			</div>
		</section>
	}

</div>


@inject HttpClient Http
@inject NavigationManager Nav
@code {
	private List<DirectBookingModel>? directBookingModels = new List<DirectBookingModel>();
	private List<OnlineBookingModel>? onlineBookingModels = new List<OnlineBookingModel>();

	public DirectBookinDTO? DirectBookinDTO = new();
	public DirectBookinDTO DirectBookinDTOs = new();

	public OnlineBookingDto? OnlineBookingDto = new();
	public OnlineBookingDto? OnlineBookingDtos = new();
	public Guid Id { get; set; }

	public bool PagedateLoad;
	public string? name;
	public string? address;
	public string? phone;
	public string? email;
	public string? agentName = "None";
	public double adults;
	public double kids;
	public string? basis;
	public double total;
	public double adultsStayTotal;
	public double kidsStayTotal;
	public double grandTotal;
	public double totalAdvancePayment;
	public double totalBalanceLKR;
	public double totalBalanceUSD;
	public bool Conformation { get; set; }
	public string? status;
	public Guid GuidId;
	public Guid ReserveNo;
	public string? CustomerType;
	public string? AccomadationType;
	public string? VoucherNo;
	public string? TourNo;
	public decimal USDExch;
	public decimal RoomRate;
	public string? Basis;
	public DateTime CheckInDate;
	public DateTime CheckOutDate;
	public TimeOnly arrivalTime;
	public TimeOnly depatureTime;
	public bool showNotification = false;
	public bool CheckIn;
	public bool CheckOut;
	
	protected override async Task OnInitializedAsync()
	{
		await LoadData();
		StateHasChanged();
	}
	public async Task LoadData()
	{

		try
		{
			directBookingModels = await Http.GetFromJsonAsync<List<DirectBookingModel>>("https://localhost:4000/api/DirectBooking");
			onlineBookingModels = await Http.GetFromJsonAsync<List<OnlineBookingModel>>("https://localhost:4000/api/OnlineBooking");
			Console.WriteLine("Pass");
			StateHasChanged();
		}
		catch (Exception ex)
		{
			Console.WriteLine("Error Massage : " + ex.Message);
		}
	}
	private async Task ClickConformationsDirect(Guid id)
	{
		try
		{
			DirectBookinDTO = await Http.GetFromJsonAsync<DirectBookinDTO>(
				$"https://localhost:4000/api/DirectBooking/{id}"
			);
			this.Id = id;
			total = kids + adults;
			name = $"{DirectBookinDTO?.FirstName + "" + DirectBookinDTO?.LastName}";
			address = DirectBookinDTO?.Address ?? "";
			phone = DirectBookinDTO?.PhoneNumber ?? "";
			email = DirectBookinDTO?.EmailAddress ?? "";
			total = adults + kids;
			Conformation = DirectBookinDTO!.Conformation;
			adults = DirectBookinDTO.Adult;
			kids = DirectBookinDTO.Kids;
			CheckInDate = DirectBookinDTO!.CheckInDate;
			CheckOutDate = DirectBookinDTO!.CheckOutDate;
			email = DirectBookinDTO?.EmailAddress ?? "";
			phone = DirectBookinDTO?.PhoneNumber ?? "";
			arrivalTime = DirectBookinDTO!.CheckInTime;
			depatureTime = DirectBookinDTO!.CheckOutTime;
			CheckIn = DirectBookinDTO.CheckIn;
			CheckOut = DirectBookinDTO.CheckOut;
			PagedateLoad = true;
			status = "DirectBooking";
			var guid = Guid.NewGuid();
			GuidId = guid;

			await JS.InvokeVoidAsync("scrollToSection", "invoice-section");

			StateHasChanged();

		}
		catch (HttpRequestException ex)
		{
			Console.WriteLine($"Connection error: {ex.Message}");
		}
		catch (Exception ex)
		{
			Console.WriteLine($"General error: {ex.Message}");
		}
	}

	private async Task ClickConformationsOnline(Guid id)
	{
		try
		{
			OnlineBookingDto = await Http.GetFromJsonAsync<OnlineBookingDto>(
						$"https://localhost:4000/api/OnlineBooking/{id}"
					);

			this.Id = id;
			total = kids + adults;
			name = $"{OnlineBookingDto?.FirstName + " " + OnlineBookingDto?.LastName}";
			address = OnlineBookingDto?.Address ?? "";
			phone = OnlineBookingDto?.PhoneNumber ?? "";
			email = OnlineBookingDto?.EmailAddress ?? "";
			CheckInDate = OnlineBookingDto!.CheckInDate;
			CheckOutDate = OnlineBookingDto!.CheckOutDate;
			total = adults + kids;
			Conformation = OnlineBookingDto!.Conformation;
			address = OnlineBookingDto?.Address ?? "";
			email = OnlineBookingDto?.EmailAddress ?? "";
			phone = OnlineBookingDto?.PhoneNumber ?? "";
			arrivalTime = OnlineBookingDto!.CheckInTime;
			depatureTime = OnlineBookingDto!.CheckOutTime;
			CheckIn = OnlineBookingDto.CheckIn;
			CheckOut = OnlineBookingDto.CheckOut;
			PagedateLoad = true;

			status = "OnlineBooking";

			await JS.InvokeVoidAsync("scrollToSection", "invoice-section");
			StateHasChanged();
		}
		catch (HttpRequestException ex)
		{
			Console.WriteLine($"Connection error: {ex.Message}");
		}
		catch (Exception ex)
		{
			Console.WriteLine($"General error: {ex.Message}");
		}
	}
	private Task clickViewAllReservations(MouseEventArgs args)
	{
		throw new NotImplementedException();
	}
	private async Task clickConform(MouseEventArgs args)
	{
		try
		{
			if (status == "DirectBooking")
			{
				try
				{
					Console.WriteLine($"Confirming booking ID: {Id}");

					// Create JSON content for the PUT request
					var jsonContent = JsonSerializer.Serialize(new { });
					var content = new StringContent(jsonContent, Encoding.UTF8, "application/json");
					var response = await Http.PutAsync($"https://localhost:4000/api/DirectBooking/{Id}/confirm", content);
					Console.WriteLine($"Response Status: {response.StatusCode}");

					if (response.IsSuccessStatusCode)
					{
						var result = await response.Content.ReadAsStringAsync();
						StateHasChanged();
						HandleUnConfirmClick("Direct Booking Sucessfully Confirming...");
						Console.WriteLine("Booking confirmed successfully");
						Console.WriteLine($"Result: {result}");
					}
					else
					{
						var errorContent = await response.Content.ReadAsStringAsync();
						Console.WriteLine($"Error confirming booking: {errorContent}");
					}
				}
				catch (Exception ex)
				{
					Console.WriteLine($"Exception: {ex.Message}");
				}
			}
			else
			{
				try
				{
					Console.WriteLine($"Confirming booking ID: {Id}");

					// Create JSON content for the PUT request
					var jsonContent = JsonSerializer.Serialize(new { });
					var content = new StringContent(jsonContent, Encoding.UTF8, "application/json");
					var response = await Http.PutAsync($"https://localhost:4000/api/OnlineBooking/{Id}/confirm", content);
					Console.WriteLine($"Response Status: {response.StatusCode}");

					if (response.IsSuccessStatusCode)
					{
						var result = await response.Content.ReadAsStringAsync();
						StateHasChanged();
						HandleUnConfirmClick("Online Booking Sucessfully Confirming.....");
						Console.WriteLine("Booking confirmed successfully");
						Console.WriteLine($"Result: {result}");
					}
					else
					{
						var errorContent = await response.Content.ReadAsStringAsync();
						Console.WriteLine($"Error confirming booking: {errorContent}");
					}
				}
				catch (Exception ex)
				{
					Console.WriteLine($"Exception: {ex.Message}");
				}
			}

		}
		catch (Exception ex)
		{
			Console.WriteLine($"Err : {ex.Message}");
		}

	}

	public void HandleUnConfirmClick(string message)
	{
		Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopRight;
		Snackbar.Configuration.MaxDisplayedSnackbars = 10;
		Snackbar.Add(message, Severity.Normal, config =>
		{
			config.ShowCloseIcon = false;
			config.SnackbarVariant = Variant.Filled;
		});
	}


	private async Task clickAdvancePay(Guid Id)
	{
		try
		{
			if (status == "DirectBooking")
			{
				var Direct = await Http.GetFromJsonAsync<DirectBookinDTO>($"https://localhost:4000/api/DirectBooking/{Id}");
				if (Direct != null)
				{
					Nav.NavigateTo($"/ClientManagement/AdvancePay/{Id}");
					HandleUnConfirmClick("Success");

				}
				else
				{
					Console.WriteLine("Err : There is no any record");
					HandleUnConfirmClick("There is no any record");

				}
			}
			else
			{
				var Online = await Http.GetFromJsonAsync<DirectBookinDTO>($"https://localhost:4000/api/OnlineBooking/{Id}");
				if (Online != null)
				{
					Nav.NavigateTo($"/ClientManagement/AdvancePay/{Id}");
					HandleUnConfirmClick("Success");

				}
				else
				{
					Console.WriteLine("Err : There is no any record");
					HandleUnConfirmClick("There is no any record");

				}
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine(ex.Message);
		}
	}
	private Task clickCancellation(MouseEventArgs args)
	{
		throw new NotImplementedException();
	}
	private async Task ClickCheckIn(MouseEventArgs args)
	{
		try
		{
			if (status == "DirectBooking")
			{
				try
				{
					Console.WriteLine($"Customer CheckIn ID: {Id}");

					// Create JSON content for the PUT request
					var jsonContent = JsonSerializer.Serialize(new { });
					var content = new StringContent(jsonContent, Encoding.UTF8, "application/json");
					var response = await Http.PutAsync($"https://localhost:4000/api/DirectBooking/{Id}/checkin", content);
					Console.WriteLine($"Response Status: {response.StatusCode}");

					if (response.IsSuccessStatusCode)
					{
						var result = await response.Content.ReadAsStringAsync();
						StateHasChanged();
						HandleUnConfirmClick("Sucessfully Check-In.....");
						Console.WriteLine("Sucessfully Check-In.....");
						Console.WriteLine($"Result: {result}");
					}
					else
					{
						var errorContent = await response.Content.ReadAsStringAsync();
						Console.WriteLine($"Error customer Check-In: {errorContent}");

					}
				}
				catch (Exception ex)
				{
					Console.WriteLine($"Exception: {ex.Message}");
				}
			}
			else
			{
				try
				{
					Console.WriteLine($"Customer CheckIn ID: {Id}");

					// Create JSON content for the PUT request
					var jsonContent = JsonSerializer.Serialize(new { });
					var content = new StringContent(jsonContent, Encoding.UTF8, "application/json");
					var response = await Http.PutAsync($"https://localhost:4000/api/OnlineBooking/{Id}/checkin", content);
					Console.WriteLine($"Response Status: {response.StatusCode}");

					if (response.IsSuccessStatusCode)
					{
						var result = await response.Content.ReadAsStringAsync();
						StateHasChanged();
						HandleUnConfirmClick("Sucessfully Check-In.....");
						Console.WriteLine("Sucessfully Check-In.....");
						Console.WriteLine($"Result: {result}");
					}
					else
					{
						var errorContent = await response.Content.ReadAsStringAsync();
						Console.WriteLine($"Error checkIn customer: {errorContent}");
					}
				}
				catch (Exception ex)
				{
					Console.WriteLine($"Exception: {ex.Message}");
				}
			}

		}
		catch (Exception ex)
		{
			Console.WriteLine($"Err : {ex.Message}");
		}
	}
	private async Task ClickCheckOut(MouseEventArgs args)
	{
		try
		{
			if (status == "DirectBooking")
			{
				try
				{
					Console.WriteLine($"Customer CheckOut ID: {Id}");

					// Create JSON content for the PUT request
					var jsonContent = JsonSerializer.Serialize(new { });
					var content = new StringContent(jsonContent, Encoding.UTF8, "application/json");
					var response = await Http.PutAsync($"https://localhost:4000/api/DirectBooking/{Id}/checkout", content);
					Console.WriteLine($"Response Status: {response.StatusCode}");

					if (response.IsSuccessStatusCode)
					{
						var result = await response.Content.ReadAsStringAsync();
						StateHasChanged();
						HandleUnConfirmClick("Sucessfully Check-Out.....");
						Console.WriteLine("Sucessfully Check-Out.....");
						Console.WriteLine($"Result: {result}");
					}
					else
					{
						var errorContent = await response.Content.ReadAsStringAsync();
						Console.WriteLine($"Error customer Check-Out: {errorContent}");

					}
				}
				catch (Exception ex)
				{
					Console.WriteLine($"Exception: {ex.Message}");
				}
			}
			else
			{
				try
				{
					Console.WriteLine($"Customer CheckIn ID: {Id}");

					// Create JSON content for the PUT request
					var jsonContent = JsonSerializer.Serialize(new { });
					var content = new StringContent(jsonContent, Encoding.UTF8, "application/json");
					var response = await Http.PutAsync($"https://localhost:4000/api/OnlineBooking/{Id}/checkout", content);
					Console.WriteLine($"Response Status: {response.StatusCode}");

					if (response.IsSuccessStatusCode)
					{
						var result = await response.Content.ReadAsStringAsync();
						StateHasChanged();
						HandleUnConfirmClick("Sucessfully Check-Out.....");
						Console.WriteLine("Sucessfully Check-Out.....");
						Console.WriteLine($"Result: {result}");
					}
					else
					{
						var errorContent = await response.Content.ReadAsStringAsync();
						Console.WriteLine($"Error CheckOut customer: {errorContent}");
					}
				}
				catch (Exception ex)
				{
					Console.WriteLine($"Exception: {ex.Message}");
				}
			}

		}
		catch (Exception ex)
		{
			Console.WriteLine($"Err : {ex.Message}");
		}
	}
	private async Task clickUnConform(MouseEventArgs args)
	{
		try
		{
			if (status == "DirectBooking")
			{
				try
				{
					Console.WriteLine($"Confirming booking ID: {Id}");

					// Create JSON content for the PUT request
					var jsonContent = JsonSerializer.Serialize(new { });
					var content = new StringContent(jsonContent, Encoding.UTF8, "application/json");
					var response = await Http.PutAsync($"https://localhost:4000/api/DirectBooking/{Id}/unconfirm", content);
					Console.WriteLine($"Response Status: {response.StatusCode}");

					if (response.IsSuccessStatusCode)
					{
						var result = await response.Content.ReadAsStringAsync();
						StateHasChanged();
						HandleUnConfirmClick("DirectBooking Sucessfully Unconfirming.....");
						Console.WriteLine("Booking confirmed successfully");
						Console.WriteLine($"Result: {result}");
					}
					else
					{
						var errorContent = await response.Content.ReadAsStringAsync();
						Console.WriteLine($"Error confirming booking: {errorContent}");

					}
				}
				catch (Exception ex)
				{
					Console.WriteLine($"Exception: {ex.Message}");
				}
			}
			else
			{
				try
				{
					Console.WriteLine($"Confirming booking ID: {Id}");

					// Create JSON content for the PUT request
					var jsonContent = JsonSerializer.Serialize(new { });
					var content = new StringContent(jsonContent, Encoding.UTF8, "application/json");
					var response = await Http.PutAsync($"https://localhost:4000/api/OnlineBooking/{Id}/unconfirm", content);
					Console.WriteLine($"Response Status: {response.StatusCode}");

					if (response.IsSuccessStatusCode)
					{
						var result = await response.Content.ReadAsStringAsync();
						StateHasChanged();
						HandleUnConfirmClick("Onlien Booking Sucessfully Unconfirming.....");
						Console.WriteLine("Booking confirmed successfully");
						Console.WriteLine($"Result: {result}");
					}
					else
					{
						var errorContent = await response.Content.ReadAsStringAsync();
						Console.WriteLine($"Error confirming booking: {errorContent}");
					}
				}
				catch (Exception ex)
				{
					Console.WriteLine($"Exception: {ex.Message}");
				}
			}

		}
		catch (Exception ex)
		{
			Console.WriteLine($"Err : {ex.Message}");
		}
	}
}
