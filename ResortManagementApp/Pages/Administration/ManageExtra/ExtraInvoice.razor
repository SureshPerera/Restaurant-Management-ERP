@page "/Administration/ManageExtra/Invoice/{Id:guid}"
@using Microsoft.JSInterop
@using ResortManagementApp.Models.Administration.DTOS
@using ResortManagementApp.Models.Administration.ManageExtra
@using System.Text.Json
@using ResortManagementApp.Pages.ComponentCss
@inject IJSRuntime JSRuntime

<PageTitle>Invoice Generator</PageTitle>

<div class="container">
	<h3>Invoice Generator</h3>

	<!-- Invoice Form -->
	@if (ExtraChargersDtos is null)
	{
		<Searching />
	}
	<div class="row">
		<div class="col-md-6">
			<div class="card">
				<div class="card-header">
					<h5>Invoice Details</h5>
				</div>
				<div class="card-body">


					<div class="mb-3">
						<label class="form-label">Invoice ID</label>
						<input @bind-value="@Id" class="form-control" />
					</div>

					<div class="mb-3">
						<label class="form-label">Extra Charge Type</label>
						<select class="form-control" @bind="ExtraChargersDtos.ExtraChargeType">
							<option value="">---Select--</option>
							@foreach (var item in ExtraChargeTypes)
							{
								<option value="@item">@item</option>
							}
						</select>
					</div>

					<div class="mb-3">
						<label class="form-label">Amount (LKR)</label>
						<input @bind-value="ExtraChargersDtos.Amount" class="form-control" />
					</div>

					<div class="mb-3">
						<label class="form-label">Rate USD</label>
						<input @bind-value="ExtraChargersDtos.RateUSD" class="form-control" />
					</div>

					<div class="mb-3">
						<label class="form-label">Rate LKR</label>
						<input @bind-value="ExtraChargersDtos.RateLKR" class="form-control" />
					</div>

					<div class="mb-3">
						<label class="form-label">Comment</label>
						<textarea @bind="ExtraChargersDtos.Comment" class="form-control" rows="3" />
					</div>

					<div class="mb-3">
						<label class="form-label">Details</label>
						<textarea @bind="ExtraChargersDtos.Details" class="form-control" rows="3" />
					</div>

					<div class="d-grid gap-2">
						<button type="submit" class="btn btn-primary" @onclick="GenerateInvoice">Generate Invoice</button>
						<button type="button" class="btn btn-success" @onclick="PrintInvoice" disabled="@(!isInvoiceGenerated)">Print Invoice</button>
						<a class="btn btn-success" href="/Administration/ManageExtra">Back</a>
					</div>

				</div>
			</div>
		</div>

		<!-- Invoice Preview -->
		<div class="col-md-6">
			<div class="card">
				<div class="card-header">
					<h5>Invoice Preview</h5>
				</div>
				<div class="card-body p-0">
					@if (isInvoiceGenerated)
					{
						<div id="invoice-content" class="invoice-container">
							@((MarkupString)invoiceHtml)
						</div>
					}
					else
					{
						<div class="text-muted p-3 text-center">
							<i class="fas fa-file-invoice fa-3x mb-3"></i>
							<p>Fill in the details and click "Generate Invoice" to see preview</p>
						</div>
					}
				</div>
			</div>
		</div>
	</div>
</div>

<style>
	.invoice-container {
		font-family: 'Courier New', monospace;
		font-size: 12px;
		line-height: 1.3;
		width: 80mm;
		margin: 0 auto;
		padding: 5mm;
		background: white;
		color: #000;
		border: 1px solid #ddd;
	}

	.invoice-header {
		text-align: center;
		border-bottom: 2px solid #000;
		padding-bottom: 8px;
		margin-bottom: 10px;
	}

	.company-name {
		font-size: 16px;
		font-weight: bold;
		margin-bottom: 3px;
	}

	.invoice-title {
		font-size: 14px;
		font-weight: bold;
		margin-top: 5px;
	}

	.invoice-info {
		margin-bottom: 10px;
		font-size: 11px;
	}

	.field {
		margin-bottom: 4px;
		display: flex;
		justify-content: space-between;
	}

	.field-label {
		font-weight: bold;
		width: 40%;
	}

	.field-value {
		width: 58%;
		text-align: right;
		word-wrap: break-word;
	}

	.amounts {
		border-top: 1px solid #000;
		border-bottom: 1px solid #000;
		padding: 8px 0;
		margin: 10px 0;
	}

	.amount-line {
		display: flex;
		justify-content: space-between;
		margin-bottom: 3px;
		font-weight: bold;
	}

	.total {
		border-top: 1px solid #000;
		padding-top: 5px;
		margin-top: 5px;
		font-size: 13px;
		font-weight: bold;
	}

	.details-section {
		margin: 10px 0;
		border-top: 1px dashed #000;
		padding-top: 8px;
	}

	.details-title {
		font-weight: bold;
		margin-bottom: 4px;
		text-decoration: underline;
	}

	.details-text {
		font-size: 11px;
		word-wrap: break-word;
	}

	.comment-section {
		margin: 8px 0;
	}

	.comment-title {
		font-weight: bold;
		margin-bottom: 3px;
	}

	.comment-text {
		font-size: 11px;
		font-style: italic;
	}

	.invoice-footer {
		text-align: center;
		margin-top: 15px;
		border-top: 2px solid #000;
		padding-top: 8px;
		font-size: 11px;
	}

	.thank-you {
		font-weight: bold;
		margin-bottom: 5px;
	}

	.separator {
		text-align: center;
		margin: 8px 0;
		font-size: 16px;
	}


	.invoice-container {
		width: 80mm;
		margin: 0;
		padding: 2mm;
		border: none;
	}

	}
</style>
@inject HttpClient http
@code {
	[Parameter]
	public Guid Id { get; set; }
	public ExtraChanrgers? ExtraChargers { get; set; } = new();
	public ExtraChargersDto ExtraChargersDtos { get; set; } = new();

	private bool isInvoiceGenerated = false;
	private string invoiceHtml = string.Empty;

	public List<string>? ExtraChargeTypes { get; set; } = new List<string>
	{
		"Early Check In", "City Tour", "Pool Tickets", "Pool Table(45 Min)", "Pre Shoot(Weddings)","Cockage-Foreiger",
		"Cockage-Local","Ladies Dress","Ladies Blouse","Bathmate Replacement", "White wine 187.5ml Mini Bar" , "Red wine 187.5ml Mini Bar",
		"Coca Cola Mini Bar", "Sprite Mini Bar", "Laundry Charges", "Day Outing Package","Extra Person FB", "Extra Person HB",
		"Extra Person BB", "Extra BB Adult", "Extra Kid BB", "Extra Kid HB", "Changing Rooms", "Soda Mini Bar", "Extra Kid BB",
		"Mineral Water 1L Min Bar", "Jambo Peanut Min Bar", "Chocolate(Mass Bar)Mini Bar","Leadies Skirt","Leadies Brassier",
		"Leadies Panties","Leadies Shorts", "Leadies Slack", "Leadies Lungi/Sarong", "Ladies Night Gown", "Leadies T-Shirt",
		"Leadies Vest", "Leadies Under Skirt","Leadies Abaya", "Leadies Socks","Gents Shirt","Gents Trouser","Gents Jacket",
		"Gents Pyjamas/Sarong", "Gents Undershirt", "Gents Under Pants", "Gents Handkerchief", "Gents Socks","Gents Shorts",
		"Gents T-Shirts", "Gents Kurutha Suit", "Children Handkerchief", "Children Shorts", "Children T-Shirt","Children Shorts",
		"Children Frock", "Children Pyjamas Suit", "Children Underwear", "Children Socks", "Children Panty", "Children Skirt",
		"Children Cap"
	};

	protected override async Task OnParametersSetAsync()
	{
		try
		{
			ExtraChargers = await http.GetFromJsonAsync<ExtraChanrgers>($"https://localhost:4000/api/ExtraCharge/{Id}");
			// var json = await response.Content.ReadAsStringAsync();
			// Console.WriteLine("API Response: " + json);

			ExtraChargersDtos.RateLKR = ExtraChargers?.RateLKR ?? 0;
			ExtraChargersDtos.RateUSD = ExtraChargers?.RateUSD ?? 0;
			ExtraChargersDtos.Comment = ExtraChargers?.Comment ?? "";
			ExtraChargersDtos.ExtraChargeType = ExtraChargers?.ExtraChargeType ?? "";
			ExtraChargersDtos.Amount = ExtraChargers?.Amount ?? 0;
			Console.WriteLine("Succusfull Loading...");


		}
		catch (Exception ex)
		{
			Console.WriteLine("Exception in OnParametersSetAsync: " + ex.Message);
		}
	}

	private void GenerateInvoice()
	{
		ExtraChargersDtos.DateTime = DateTime.Now;
		invoiceHtml = GenerateInvoiceHtml();
		isInvoiceGenerated = true;
		StateHasChanged();
	}

	private async Task PrintInvoice()
	{
		if (isInvoiceGenerated)
		{
			await JSRuntime.InvokeVoidAsync("window.print");
		}
	}

	private string GenerateInvoiceHtml()
	{
		decimal amount = ExtraChargersDtos.Amount ?? 0m;
		decimal total;

		if (ExtraChargersDtos.RateLKR.HasValue)
		{
			total = ExtraChargersDtos.RateLKR.Value * amount;
		}
		else if (ExtraChargersDtos.RateUSD.HasValue)
		{
			total = ExtraChargersDtos.RateUSD.Value * amount;
		}
		else
		{
			total = amount; // fallback if both are null
		}
		return $@"
            <div class='invoice-header'>
                <div class='company-name'>SOLITARY GREEN RESORT</div>
                <div>Solitory Green Rosort</div>
                <div>Oddington Estate,Lindula,</div>
                <div>Nuwara Eliya, Sri Lanka.</div>
                <div>Phone: +94 761 733 573</div>
                <div class='invoice-title'>EXTRA ITEM INVOICE</div>
            </div>

            <div class='invoice-info'>
                <div class='field'>
                    <span class='field-label'>Invoice ID:</span>
                    <span class='field-value'>{Id}</span>
                </div>
                <div class='field'>
                    <span class='field-label'>Date & Time:</span>
                    <span class='field-value'>{ExtraChargersDtos.DateTime:dd/MM/yyyy hh:mm tt}</span>
                </div>
                <div class='field'>
                    <span class='field-label'>Charge Type:</span>
                    <span class='field-value'>{ExtraChargersDtos.ExtraChargeType}</span>
                </div>
            </div>

            <div class='amounts'>
                <div class='amount-line'>
                    <span>Amount:</span>
                    <span>{ExtraChargersDtos.Amount:N2}</span>
                </div>
                <div class='amount-line'>
                    <span>Rate USD:</span>
                    <span>${ExtraChargersDtos.RateUSD:N2}</span>
                </div>
                <div class='amount-line'>
                    <span>Rate LKR:</span>
                    <span>Rs. {ExtraChargersDtos.RateLKR:N2}</span>
                </div>
                <div class='total'>
                    <div class='amount-line'>
                        <span>TOTAL:</span>
					<span> Rs. {total:N2}</span>
				</div>
				</div>
		</div>

		<div class='details-section'>
			<div class='details-title'>Details:</div>
			<div class='details-text'>{ExtraChargersDtos.Details}</div>
		</div>

		<div class='comment-section'>
			<div class='comment-title'>Comment:</div>
			<div class='comment-text'>{ExtraChargersDtos.Comment}</div>
		</div>

		<div class='separator'>* * * * * * * * * *</div>

		<div class='invoice-footer'>
			<div class='thank-you'>THANK YOU FOR USING OUR SERVICES!</div>
			<div>We appreciate your business</div>
			<div>Visit us again soon</div>
			<div style='margin-top: 8px; font-size: 10px;'>
				Invoice generated on: {DateTime.Now:dd/MM/yyyy hh:mm:ss tt}
			</div>
		</div>

		<div class='separator'>* * * * * * * * * *</div>
		";
	}


}